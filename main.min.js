var hoveredFields;

$.ajaxSetup({ cache: false });
$(document).on({
    ready: function () {
        setTimeout(function () {
            topDonator()
        }, 250)
    }
});

initFields = function () {
    var enterevent = "mouseenter";
    var exitevent = "mouseleave"
    var clickevent = "click";
    $("#stadium").mouseleave(hideTooltip);
    $("#sponsor-tooltip").mouseenter(hideTooltip)

    $(".sold").on(enterevent, soldFieldHoverIn);
    $(".sold").on(exitevent, hideMultipleDonators);
    $(".field").on(clickevent, fieldClick);
};
hideMultipleDonators = function(){
    hoveredFields.each(function(i,el){
        $(el).toggleClass("hovered"); 
        hideTooltip();
    });
}
emptyFieldHoverIn = function () {
    hideTooltip();
};
showTooltip = function (event) {
    moveTooltip(event);
    $("#sponsor-tooltip").css("visibility", "visible")
};
hideTooltip = function () {
    $("#sponsor-tooltip").css("visibility", "hidden")
};
initPopover = function () {
    $(".popover").on("mouseenter", function () {
        $("#sponsor-tooltip").css("visibility", "hidden")
    })
};
moveTooltip = function (event) {
    if ($(event.target).attr("id").split("_")[2] > fieldWidth / 2) {
        $("#sponsor-tooltip").prop("class", "tooltip left in");
        $("#sponsor-tooltip").offset({ top: event.pageY - 12, left: event.pageX - ($("#sponsor-tooltip").width() + 16) })
    } else {
        $("#sponsor-tooltip").prop("class", "tooltip right in");
        $("#sponsor-tooltip").offset({ top: event.pageY - 12, left: event.pageX + 16 })
    }
};
soldFieldHoverIn = function (event) {
    $("#sponsor-tooltip-content").html($(this).attr("data-s"));
    var attr = 'i[data-s="';
    attr += $(this).attr("data-s");
    attr += '"]';
    hoveredFields = $(attr);
    hoveredFields.each(function(i,el){
        $(el).toggleClass("hovered"); // works
    });

    showTooltip(event);
};
fieldClick = function (event) {
    var field = $(this);
    hideTooltip();
    if (makePopover(field, event)) {
        movePopover(event);
        $("#sponsor-popover").css("visibility", "visible");
        initPopover()
    }
};
closePopover = function () {
    $("#sponsor-popover").css("visibility", "hidden");
};

makePopover = function (field, event) {
    var isSold = $(field).hasClass("sold")
    var ids = $(field).attr("id").substring(6);
    var fieldnr = $(field).attr("idx")
    var j = ids.substring(0, ids.indexOf("_"));
    var i = ids.substring(ids.indexOf("_") + 1);
    var popover = $("#sponsor-popover");
    var popoverContent = popover.find(".popover-content");
    var soldName = $(field).attr("data-s");
    popover.data("j", j);
    popover.data("i", i);

    if (isSold) {
        popover.find(".popover-title").html('<div>Wir bedanken uns bei: <a href="#" class="pull-right" onclick="closePopover(); return false;">&times;</a></div>');
        var content = "<strong>" + soldName + "</strong>";

        popoverContent.html(content)
        return true
    }

    popover.find(".popover-title").html('<div>Koordinaten <a href="#" class="pull-right" onclick="closePopover(); return false;">&times;</a></div>');
    popover.find(".popover-title")[0].innerHTML += " <small>x: " + j + ", y: " + i + "</small>";
    var content = '<div style="text-align:center;">Dieses Feld könnte Ihres sein...</br><b>Feldnummer: </b>' + fieldnr + '</div>'
    popoverContent.html(content);
    return true
};
movePopover = function (event) {
    var popover = $("#sponsor-popover");
    if (tablet) {
        for (var i = 0; i <= 4; i++) {
            event = event.originalEvent.changedTouches[i];
            if (event.pageX) {
                break
            }
        }
    }
    var i = popover.data("i");
    var j = popover.data("j");
    clearPopoverArrows();
    if (i < 20) {
        var top = event.pageY - popover.height() / 2 - 5;
        var left = event.pageX + 25;
        popover.removeClass("top");
        popover.addClass("right")
    } else if (i > fieldWidth - 20) {
        var top = event.pageY - popover.height() / 2 - 5;
        var left = event.pageX - popover.width() - 25;
        popover.removeClass("top");
        popover.addClass("left")
    } else if (j < 20) {
        var top = event.pageY + 20;
        var left = event.pageX - popover.width() / 2;
        popover.removeClass("top");
        popover.addClass("bottom")
    } else {
        var top = event.pageY - popover.height() - 20;
        var left = event.pageX - popover.width() / 2;
        popover.removeClass("bottom");
        popover.addClass("top")
    }
    popover.offset({ top: top, left: left })
};
clearPopoverArrows = function () {
    var popover = $("#sponsor-popover");
    popover.removeClass("top");
    popover.removeClass("bottom");
    popover.removeClass("left");
    popover.removeClass("right")
};
isIFrame = function () {
    return $("body").hasClass("layout-iframe")
};

topDonator = function () {
    var donatorMap = new Map();
    var fields = document.getElementsByTagName("i");

    for (i = 0; i < fields.length; i++) {
        var nameToAdd = fields[i].getAttribute("data-s");
        var area_1 = fields[i].classList.contains("area-1");
        var area_2 = fields[i].classList.contains("area-2");
        var amountToAdd = 0;
        if (area_1) {
            amountToAdd += 20;
        }
        else if (area_2) {
            amountToAdd += 40;
        }
        else {
            amountToAdd += 30;
        }

        if (nameToAdd != "Name") {
            if (!donatorMap.has(nameToAdd)) {

                donatorMap.set(nameToAdd, amountToAdd);
            }
            else {
                var donatorAmount = donatorMap.get(nameToAdd);
                donatorMap.set(nameToAdd, donatorAmount + amountToAdd);
            }
        }
    }

    const sortedMap = new Map([...donatorMap.entries()].sort((a, b) => b[1] - a[1]));
    var divELem = document.createElement('div');
    divELem.classList.add('list-type1');
    var donatorList = document.createElement('ol');

    var count = 0;
    for (var [key, value] of sortedMap) {
        if (count > 9) { break; }
        var listViewItem = document.createElement('li');
        var textToDisplay = key + ": " + value + " €";
        listViewItem.appendChild(document.createTextNode(textToDisplay));
        donatorList.appendChild(listViewItem);
        count++;
    }

    divELem.appendChild(donatorList);
    document.getElementById("topDonatorList").appendChild(divELem);
}
